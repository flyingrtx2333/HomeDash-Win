<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HomeDash Win</title>
    <link rel="icon" type="image/png" href="/static/images/logo16.png" />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <!-- èƒŒæ™¯å±‚ -->
    <div class="bg-layer" id="bgLayer"></div>
    <div class="bg-overlay"></div>

    <div class="app-container">
      <!-- å·¦ä¾§å¯¼èˆªæ  -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">HomeDash</div>
        </div>
        <nav class="sidebar-nav">
          <a class="nav-item active" data-page="home">
            <span class="nav-icon">ğŸ </span>
            <span>é¦–é¡µ</span>
          </a>
          <a class="nav-item" data-page="monitor">
            <span class="nav-icon">ğŸ“Š</span>
            <span>ç³»ç»Ÿç›‘æ§</span>
          </a>
          <a class="nav-item" data-page="process">
            <span class="nav-icon">âš™ï¸</span>
            <span>è¿›ç¨‹ç®¡ç†</span>
          </a>
          <a class="nav-item" data-page="files">
            <span class="nav-icon">ğŸ“</span>
            <span>æ–‡ä»¶ç®¡ç†</span>
          </a>
          <a class="nav-item" data-page="ssh">
            <span class="nav-icon">ğŸ’»</span>
            <span>SSH ç»ˆç«¯</span>
          </a>
          <a class="nav-item" data-page="docker">
            <span class="nav-icon">ğŸ³</span>
            <span>Docker</span>
          </a>
        </nav>
        <div class="sidebar-footer">
          HomeDash v1.0
        </div>
      </aside>

      <!-- ä¸»å†…å®¹åŒº -->
      <main class="main-content">
        <!-- é¡¶éƒ¨æ  -->
        <header class="top-bar">
          <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
          <div class="ip-input-container">
            <label for="serverIp">æœåŠ¡å™¨ï¼š</label>
            <input 
              type="text" 
              id="serverIp" 
              placeholder="ä¾‹å¦‚: 192.168.1.100" 
              value="localhost"
            />
          </div>
          <!-- çŠ¶æ€å°å›¾æ ‡ -->
          <div class="top-bar-stats" id="topBarStats">
            <div class="stat-mini" title="CPU">
              <span class="stat-icon">ğŸ’»</span>
              <span class="stat-value" id="topCpu">--%</span>
            </div>
            <div class="stat-mini" title="å†…å­˜">
              <span class="stat-icon">ğŸ§ </span>
              <span class="stat-value" id="topMem">--%</span>
            </div>
            <div class="stat-mini" title="GPU">
              <span class="stat-icon">ğŸ®</span>
              <span class="stat-value" id="topGpu">--%</span>
            </div>
            <div class="stat-mini stat-network" title="ç½‘ç»œ">
              <span class="stat-icon">ğŸŒ</span>
              <span class="stat-value">
                <span class="net-up">â†‘<span id="topNetUp">--</span></span>
                <span class="net-down">â†“<span id="topNetDown">--</span></span>
              </span>
            </div>
          </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
          <!-- é¦–é¡µ -->
          <div class="page-view active" id="page-home">
            <section class="section">
              <div class="section-header">
                <h2>æœåŠ¡å…¥å£</h2>
                <div class="header-actions">
                  <button class="btn-outline" id="pingAllBtn" title="æ£€æµ‹æ‰€æœ‰æœåŠ¡è¿é€šæ€§">ğŸ” æ£€æµ‹è¿é€š</button>
                  <button class="btn-outline" id="importTemplateBtn" title="å¯¼å…¥æ¨èæœåŠ¡æ¨¡æ¿">ğŸ“¥ å¯¼å…¥æ¨¡æ¿</button>
                  <button class="add-service-btn" id="addServiceBtn">+ æ·»åŠ æœåŠ¡</button>
                </div>
              </div>
              <div class="grid" id="servicesGrid">
                <!-- æœåŠ¡å¡ç‰‡å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
              </div>
              <!-- ç©ºçŠ¶æ€æç¤º -->
              <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“¦</div>
                <p>è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•æœåŠ¡</p>
                <button class="btn btn-primary" id="emptyImportBtn">å¯¼å…¥æ¨èæ¨¡æ¿</button>
              </div>
            </section>
          </div>

          <!-- ç›‘æ§é¡µé¢ -->
          <div class="page-view" id="page-monitor">
            <div class="connection-status">
              <span class="status-dot" id="statusDot"></span>
              <span id="statusText">æ­£åœ¨è¿æ¥...</span>
            </div>

            <div class="monitor-grid">
              <!-- CPU -->
              <div class="monitor-card">
                <h3>CPU ä½¿ç”¨ç‡</h3>
                <div class="progress-ring">
                  <svg>
                    <circle class="progress-ring-bg" cx="70" cy="70" r="60"></circle>
                    <circle class="progress-ring-fill cpu" id="cpuRing" cx="70" cy="70" r="60"></circle>
                  </svg>
                  <div class="progress-value"><span id="cpuValue">0</span><span>%</span></div>
                </div>
                <div class="monitor-info">
                  <span class="label" id="cpuModel">-</span>
                  <span class="value" id="cpuCores">- æ ¸å¿ƒ</span>
                </div>
                <div class="temp-badge" id="cpuTemp" style="display: none;">
                  <span class="temp-icon">ğŸŒ¡ï¸</span>
                  <span class="temp-value">--</span>Â°C
                </div>
              </div>

              <!-- å†…å­˜ -->
              <div class="monitor-card">
                <h3>å†…å­˜ä½¿ç”¨ç‡</h3>
                <div class="progress-ring">
                  <svg>
                    <circle class="progress-ring-bg" cx="70" cy="70" r="60"></circle>
                    <circle class="progress-ring-fill memory" id="memoryRing" cx="70" cy="70" r="60"></circle>
                  </svg>
                  <div class="progress-value"><span id="memoryValue">0</span><span>%</span></div>
                </div>
                <div class="monitor-info">
                  <span class="label" id="memoryUsed">0 GB / 0 GB</span>
                  <span class="value" id="memoryAvailable">å¯ç”¨: 0 GB</span>
                </div>
              </div>

              <!-- GPU -->
              <div class="monitor-card">
                <h3>GPU ä½¿ç”¨ç‡</h3>
                <div id="gpuContent">
                  <div class="progress-ring">
                    <svg>
                      <circle class="progress-ring-bg" cx="70" cy="70" r="60"></circle>
                      <circle class="progress-ring-fill gpu" id="gpuRing" cx="70" cy="70" r="60"></circle>
                    </svg>
                    <div class="progress-value"><span id="gpuValue">0</span><span>%</span></div>
                  </div>
                  <div class="monitor-info">
                    <span class="label" id="gpuModel">-</span>
                    <span class="value" id="gpuMemory">æ˜¾å­˜: 0 / 0 MB</span>
                  </div>
                  <div class="temp-badge" id="gpuTemp">
                    <span class="temp-icon">ğŸŒ¡ï¸</span>
                    <span class="temp-value">--</span>Â°C
                  </div>
                </div>
                <div id="gpuUnavailable" class="gpu-unavailable" style="display: none;">
                  GPU ä¸å¯ç”¨æˆ–æœªæ£€æµ‹åˆ°
                </div>
              </div>

              <!-- ç½‘ç»œæµé‡ -->
              <div class="monitor-card network-card">
                <h3>ç½‘ç»œæµé‡</h3>
                <div class="network-stats">
                  <div class="network-speed">
                    <div class="speed-item upload">
                      <span class="speed-icon">â†‘</span>
                      <span class="speed-value" id="netSpeedUp">0 B/s</span>
                    </div>
                    <div class="speed-item download">
                      <span class="speed-icon">â†“</span>
                      <span class="speed-value" id="netSpeedDown">0 B/s</span>
                    </div>
                  </div>
                  <div class="network-total">
                    <div class="total-item">
                      <span class="total-label">ç´¯è®¡ä¸Šä¼ </span>
                      <span class="total-value" id="netTotalUp">0 B</span>
                    </div>
                    <div class="total-item">
                      <span class="total-label">ç´¯è®¡ä¸‹è½½</span>
                      <span class="total-value" id="netTotalDown">0 B</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ç£ç›˜ä½¿ç”¨ -->
            <div class="disk-section">
              <h3>ç£ç›˜ä½¿ç”¨</h3>
              <div id="diskList"></div>
            </div>
          </div>

          <!-- è¿›ç¨‹ç®¡ç†é¡µé¢ -->
          <div class="page-view" id="page-process">
            <div class="section-header">
              <h2>è¿›ç¨‹ç®¡ç†</h2>
              <button class="btn-outline" id="refreshProcessBtn">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div class="process-table-container">
              <table class="process-table">
                <thead>
                  <tr>
                    <th>PID</th>
                    <th>è¿›ç¨‹å</th>
                    <th>CPU %</th>
                    <th>å†…å­˜</th>
                    <th>çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody id="processTableBody">
                  <tr>
                    <td colspan="5" class="loading-row">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- æ–‡ä»¶ç®¡ç†é¡µé¢ -->
          <div class="page-view" id="page-files">
            <div class="section-header">
              <h2>æ–‡ä»¶ç®¡ç†</h2>
              <div class="header-actions">
                <button class="btn-outline" id="newFolderBtn">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</button>
                <button class="btn-outline" id="uploadFileBtn">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</button>
                <input type="file" id="fileUploadInput" hidden multiple />
              </div>
            </div>
            <!-- WebDAV æŒ‚è½½ç›®å½•è®¾ç½® -->
            <div class="webdav-settings">
              <label>ğŸ“‚ æŒ‚è½½ç›®å½•ï¼š</label>
              <input type="text" id="webdavRootInput" placeholder="ä¾‹å¦‚: C:\Users\Public" />
              <button class="btn-outline" id="setWebdavRootBtn">åº”ç”¨</button>
            </div>
            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <div class="breadcrumb" id="breadcrumb">
              <span class="breadcrumb-item" data-path="/">ğŸ  æ ¹ç›®å½•</span>
            </div>
            <!-- WebDAV ä¿¡æ¯ -->
            <div class="webdav-info">
              <span>ğŸ“¡ WebDAV åœ°å€ï¼š</span>
              <code id="webdavUrl">-</code>
              <button class="btn-copy" id="copyWebdavBtn" title="å¤åˆ¶åœ°å€">ğŸ“‹</button>
            </div>
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div class="file-list-container">
              <table class="file-table">
                <thead>
                  <tr>
                    <th class="col-icon"></th>
                    <th class="col-name">åç§°</th>
                    <th class="col-size">å¤§å°</th>
                    <th class="col-time">ä¿®æ”¹æ—¶é—´</th>
                    <th class="col-actions">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="fileTableBody">
                  <tr>
                    <td colspan="5" class="loading-row">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- SSH ç»ˆç«¯é¡µé¢ -->
          <div class="page-view" id="page-ssh">
            <div class="section-header">
              <h2>SSH ç»ˆç«¯</h2>
              <div class="header-actions">
                <span class="terminal-status" id="terminalStatus">
                  <span class="status-dot"></span>
                  <span>æœªè¿æ¥</span>
                </span>
                <button class="btn-outline" id="connectTerminalBtn">ğŸ”Œ é‡è¿</button>
                <button class="btn-outline" id="clearTerminalBtn">ğŸ—‘ï¸ æ¸…å±</button>
              </div>
            </div>
            <div class="terminal-container" id="terminalContainer">
              <div class="terminal-header">
                <div class="terminal-dots">
                  <span class="terminal-dot red"></span>
                  <span class="terminal-dot yellow"></span>
                  <span class="terminal-dot green"></span>
                </div>
                <div class="terminal-title">
                  <span>PowerShell</span>
                </div>
              </div>
              <div class="terminal-wrapper" id="terminal" tabindex="0">
                <div class="terminal-output" id="terminalOutput"></div>
                <div class="terminal-input-line">
                  <span class="terminal-prompt" id="terminalPrompt">PS&gt;</span>
                  <input type="text" class="terminal-input" id="terminalInput" autofocus />
                </div>
              </div>
            </div>
          </div>

          <!-- Docker ç®¡ç†é¡µé¢ -->
          <div class="page-view" id="page-docker">
            <div class="section-header">
              <h2>Docker å®¹å™¨</h2>
              <div class="header-actions">
                <button class="btn-outline" id="refreshDockerBtn">ğŸ”„ åˆ·æ–°</button>
              </div>
            </div>
            <div class="docker-status" id="dockerStatus">
              <span class="status-dot"></span>
              <span>æ£€æµ‹ä¸­...</span>
            </div>
            <div class="docker-table-container">
              <table class="docker-table">
                <thead>
                  <tr>
                    <th class="col-status"></th>
                    <th>åç§°</th>
                    <th>é•œåƒ</th>
                    <th>çŠ¶æ€</th>
                    <th>ç«¯å£</th>
                  </tr>
                </thead>
                <tbody id="dockerTableBody">
                  <tr>
                    <td colspan="5" class="loading-row">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- é¡µè„š -->
        <footer class="page-footer">
          <span>HomeDash Win Â· Windows å®¶åº­æœåŠ¡å™¨çœ‹æ¿</span>
          <a href="https://github.com/flyingrtx2333/HomeDash-Win" target="_blank" rel="noopener" class="github-link" title="GitHub">
            <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
          </a>
        </footer>
      </main>
    </div>

    <!-- è®¾ç½®æŒ‰é’® -->
    <button class="settings-btn" id="settingsBtn" title="è®¾ç½®èƒŒæ™¯">âš™ï¸</button>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
      <h3>è®¾ç½®</h3>
      <div class="settings-section">
        <label>ä¸»é¢˜æ¨¡å¼</label>
        <div class="theme-toggle">
          <span>ğŸŒ™</span>
          <label class="toggle-switch">
            <input type="checkbox" id="themeToggle" />
            <span class="toggle-slider"></span>
          </label>
          <span>â˜€ï¸</span>
        </div>
      </div>
      <div class="settings-section">
        <label>é€‰æ‹©é¢„è®¾èƒŒæ™¯</label>
        <div class="bg-grid" id="bgGrid"></div>
      </div>
    </div>

    <!-- æœåŠ¡ç¼–è¾‘å¼¹çª— -->
    <div class="modal-overlay" id="serviceModal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalTitle">æ·»åŠ æœåŠ¡</h3>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <form id="serviceForm">
          <div class="form-group">
            <label for="serviceName">æœåŠ¡åç§° *</label>
            <input type="text" id="serviceName" required placeholder="ä¾‹å¦‚: Alist" />
          </div>
          <div class="form-group">
            <label for="serviceDesc">æè¿°</label>
            <input type="text" id="serviceDesc" placeholder="ä¾‹å¦‚: å¤šç½‘ç›˜æ•´åˆ" />
          </div>
          <div class="form-group">
            <label for="servicePort">ç«¯å£å·</label>
            <div class="port-input-group">
              <input type="number" id="servicePort" placeholder="ä¾‹å¦‚: 5244 (ç•™ç©ºè¡¨ç¤ºæœ¬åœ°åº”ç”¨)" />
              <button type="button" class="btn-fetch-icon" id="fetchFaviconBtn" title="è‡ªåŠ¨è·å–å›¾æ ‡">ğŸ” è·å–å›¾æ ‡</button>
            </div>
          </div>
          <div class="form-group">
            <label>å›¾æ ‡</label>
            <!-- å›¾æ ‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="icon-upload-zone" id="iconUploadZone">
              <div class="upload-preview" id="uploadPreview"></div>
              <div class="upload-hint" id="uploadHint">
                <span class="upload-icon">ğŸ“¤</span>
                <p>æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                <span class="upload-tip">æ”¯æŒ PNG, JPG, GIF, WebP, ICO (æœ€å¤§ 2MB)</span>
              </div>
              <input type="file" id="iconFileInput" accept="image/*" hidden />
            </div>
            <!-- Emoji å¿«æ·é€‰æ‹© -->
            <div class="icon-selector" id="iconSelector">
              <div class="icon-option" data-icon="ğŸŒ">ğŸŒ</div>
              <div class="icon-option" data-icon="ğŸ“">ğŸ“</div>
              <div class="icon-option" data-icon="ğŸ¬">ğŸ¬</div>
              <div class="icon-option" data-icon="ğŸ“·">ğŸ“·</div>
              <div class="icon-option" data-icon="ğŸ®">ğŸ®</div>
              <div class="icon-option" data-icon="ğŸ’¾">ğŸ’¾</div>
              <div class="icon-option" data-icon="ğŸ”§">ğŸ”§</div>
              <div class="icon-option" data-icon="ğŸ€">ğŸ€</div>
              <div class="icon-option" data-icon="â˜€ï¸">â˜€ï¸</div>
              <div class="icon-option" data-icon="ğŸŒ™">ğŸŒ™</div>
              <div class="icon-option" data-icon="ğŸ–¥ï¸">ğŸ–¥ï¸</div>
              <div class="icon-option" data-icon="ğŸ¤–">ğŸ¤–</div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
              <input type="text" id="serviceIcon" placeholder="æˆ–è¾“å…¥å›¾ç‰‡è·¯å¾„: /static/images/xxx.png" />
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="deleteModal">
      <div class="modal modal-small">
        <div class="modal-header">
          <h3>ç¡®è®¤åˆ é™¤</h3>
        </div>
        <p class="modal-body">ç¡®å®šè¦åˆ é™¤æœåŠ¡ã€Œ<span id="deleteServiceName"></span>ã€å—ï¼Ÿ</p>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">åˆ é™¤</button>
        </div>
      </div>
    </div>

    <!-- æ–°å»ºæ–‡ä»¶å¤¹å¼¹çª— -->
    <div class="modal-overlay" id="newFolderModal">
      <div class="modal modal-small">
        <div class="modal-header">
          <h3>æ–°å»ºæ–‡ä»¶å¤¹</h3>
          <button class="modal-close" id="closeFolderModal">&times;</button>
        </div>
        <div class="form-group">
          <label for="folderName">æ–‡ä»¶å¤¹åç§°</label>
          <input type="text" id="folderName" placeholder="è¾“å…¥æ–‡ä»¶å¤¹åç§°" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancelFolderBtn">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="confirmFolderBtn">åˆ›å»º</button>
        </div>
      </div>
    </div>

    <!-- åˆ é™¤æ–‡ä»¶ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="deleteFileModal">
      <div class="modal modal-small">
        <div class="modal-header">
          <h3>ç¡®è®¤åˆ é™¤</h3>
        </div>
        <p class="modal-body">ç¡®å®šè¦åˆ é™¤ã€Œ<span id="deleteFileName"></span>ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancelDeleteFileBtn">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteFileBtn">åˆ é™¤</button>
        </div>
      </div>
    </div>

    <script>
      // ========== å…¨å±€å˜é‡ ==========
      const bgLayer = document.getElementById('bgLayer');
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsPanel = document.getElementById('settingsPanel');
      const bgGrid = document.getElementById('bgGrid');
      const serverIpInput = document.getElementById('serverIp');
      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const servicesGrid = document.getElementById('servicesGrid');
      const emptyState = document.getElementById('emptyState');

      let presetBackgrounds = [];
      let currentSettings = { serverIp: 'localhost', backgroundUrl: '' };
      let services = [];
      let pingResults = {}; // å­˜å‚¨è¿é€šæ€§æ£€æµ‹ç»“æœ
      let saveTimer = null;
      let monitorWs = null;
      let reconnectTimer = null;
      let editingServiceId = null;
      let pingInterval = null;

      // æ–‡ä»¶ç®¡ç†ç›¸å…³
      let currentFilePath = '/';
      let deletingFilePath = null;

      // ç»ˆç«¯ç›¸å…³
      let terminalWs = null;
      let terminalHistory = [];
      let historyIndex = -1;

      // ========== æœåŠ¡ç®¡ç† ==========
      async function loadServices() {
        try {
          const response = await fetch('/api/services');
          if (response.ok) {
            services = await response.json();
          }
        } catch (e) {
          console.log('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥');
        }
        renderServices();
      }

      function renderServices() {
        // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
        if (services.length === 0) {
          servicesGrid.style.display = 'none';
          emptyState.style.display = 'flex';
          return;
        }
        servicesGrid.style.display = 'grid';
        emptyState.style.display = 'none';

        const ip = currentSettings.serverIp || 'localhost';
        servicesGrid.innerHTML = services.map(service => {
          const isEnabled = service.enabled && service.port > 0;
          const url = isEnabled ? `http://${ip}:${service.port}` : '#';
          const linkText = isEnabled ? url : 'æœ¬åœ°åº”ç”¨';
          const cardClass = isEnabled ? 'card service-card' : 'card service-card card-disabled';
          const isImage = service.icon && service.icon.startsWith('/');
          const iconHtml = isImage 
            ? `<img class="card-icon" src="${service.icon}" alt="${service.name}" />`
            : `<div class="card-icon">${service.icon || 'ğŸŒ'}</div>`;
          
          // è¿é€šçŠ¶æ€æŒ‡ç¤ºå™¨
          const ping = pingResults[service.id];
          let statusHtml = '';
          if (isEnabled && ping) {
            const statusClass = ping.status === 'ok' ? 'status-ok' : 
                               ping.status === 'slow' ? 'status-slow' : 'status-error';
            const statusIcon = ping.status === 'ok' ? 'âœ“' : 
                              ping.status === 'slow' ? 'âš ' : 'âœ—';
            const latencyText = ping.latency > 0 ? `${ping.latency}ms` : '';
            statusHtml = `<div class="ping-status ${statusClass}"><span>${statusIcon}</span><span>${latencyText}</span></div>`;
          } else if (isEnabled) {
            statusHtml = `<div class="ping-status status-unknown"><span>?</span></div>`;
          }
          
          return `
            <div class="${cardClass}" data-id="${service.id}" data-port="${service.port || 0}">
              <div class="card-actions">
                <button class="card-action-btn edit-btn" data-id="${service.id}" title="ç¼–è¾‘">âœï¸</button>
                <button class="card-action-btn delete-btn" data-id="${service.id}" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </div>
              ${statusHtml}
              ${isEnabled ? `<a href="${url}" target="_blank" rel="noreferrer" class="card-link">` : '<div class="card-link">'}
                ${iconHtml}
                <h3>${service.name}</h3>
                <p>${service.description || ''}</p>
                <span class="link">${linkText}</span>
              ${isEnabled ? '</a>' : '</div>'}
            </div>
          `;
        }).join('');

        // ç»‘å®šç¼–è¾‘/åˆ é™¤äº‹ä»¶
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditModal(btn.dataset.id);
          });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            openDeleteModal(btn.dataset.id);
          });
        });
      }

      function updateServiceLinks() {
        const ip = currentSettings.serverIp || 'localhost';
        document.querySelectorAll('.service-card').forEach(card => {
          const port = parseInt(card.dataset.port);
          if (port > 0) {
            const url = `http://${ip}:${port}`;
            const link = card.querySelector('.card-link');
            if (link && link.tagName === 'A') {
              link.href = url;
            }
            const linkText = card.querySelector('.link');
            if (linkText) {
              linkText.textContent = url;
            }
          }
        });
      }

      // ========== è¿é€šæ€§æ£€æµ‹ ==========
      async function pingAllServices() {
        const btn = document.getElementById('pingAllBtn');
        btn.disabled = true;
        btn.textContent = 'ğŸ”„ æ£€æµ‹ä¸­...';
        
        try {
          const response = await fetch('/api/ping-all');
          if (response.ok) {
            const results = await response.json();
            results.forEach(r => {
              pingResults[r.id] = r;
            });
            renderServices();
          }
        } catch (e) {
          console.log('è¿é€šæ€§æ£€æµ‹å¤±è´¥');
        }
        
        btn.disabled = false;
        btn.textContent = 'ğŸ” æ£€æµ‹è¿é€š';
      }

      // ========== æ¨¡æ¿å¯¼å…¥ ==========
      async function importTemplate() {
        if (!confirm('æ˜¯å¦å¯¼å…¥æ¨èæœåŠ¡æ¨¡æ¿ï¼Ÿå·²å­˜åœ¨çš„åŒåæœåŠ¡ä¸ä¼šé‡å¤æ·»åŠ ã€‚')) return;
        
        try {
          const response = await fetch('/api/services/import-template', { method: 'POST' });
          if (response.ok) {
            await loadServices();
            alert('å¯¼å…¥æˆåŠŸï¼');
          }
        } catch (e) {
          alert('å¯¼å…¥å¤±è´¥');
        }
      }

      // ========== Favicon æŠ“å– ==========
      async function fetchFavicon() {
        const port = document.getElementById('servicePort').value;
        if (!port) {
          alert('è¯·å…ˆå¡«å†™ç«¯å£å·');
          return;
        }
        
        const ip = currentSettings.serverIp || 'localhost';
        const url = `http://${ip}:${port}`;
        
        const btn = document.getElementById('fetchFaviconBtn');
        btn.disabled = true;
        btn.textContent = 'è·å–ä¸­...';
        
        try {
          const response = await fetch(`/api/favicon?url=${encodeURIComponent(url)}`);
          const result = await response.json();
          
          if (result.success && result.icon) {
            document.getElementById('serviceIcon').value = result.icon;
            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('active'));
            alert('å›¾æ ‡è·å–æˆåŠŸï¼');
          } else {
            alert('æ— æ³•è·å–å›¾æ ‡: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (e) {
          alert('è·å–å›¾æ ‡å¤±è´¥');
        }
        
        btn.disabled = false;
        btn.textContent = 'ğŸ” è·å–å›¾æ ‡';
      }

      // ========== è¿›ç¨‹ç®¡ç† ==========
      async function loadProcesses() {
        const tbody = document.getElementById('processTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½ä¸­...</td></tr>';
        
        try {
          const response = await fetch('/api/processes');
          if (response.ok) {
            const processes = await response.json();
            renderProcesses(processes);
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½å¤±è´¥</td></tr>';
        }
      }

      function renderProcesses(processes) {
        const tbody = document.getElementById('processTableBody');
        if (!processes || processes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="loading-row">æš‚æ— æ•°æ®</td></tr>';
          return;
        }
        
        tbody.innerHTML = processes.map(p => {
          const cpuClass = p.cpu > 50 ? 'high' : p.cpu > 20 ? 'medium' : '';
          return `
            <tr>
              <td class="pid">${p.pid}</td>
              <td class="name">${p.name}</td>
              <td class="cpu ${cpuClass}">${p.cpu.toFixed(1)}%</td>
              <td class="memory">${formatBytes(p.memory)}</td>
              <td class="status">${p.status || '-'}</td>
            </tr>
          `;
        }).join('');
      }

      // ========== å¼¹çª—ç®¡ç† ==========
      const serviceModal = document.getElementById('serviceModal');
      const serviceForm = document.getElementById('serviceForm');
      const modalTitle = document.getElementById('modalTitle');
      const addServiceBtn = document.getElementById('addServiceBtn');
      const modalClose = document.getElementById('modalClose');
      const cancelBtn = document.getElementById('cancelBtn');

      const deleteModal = document.getElementById('deleteModal');
      const deleteServiceName = document.getElementById('deleteServiceName');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      let deletingServiceId = null;

      addServiceBtn.addEventListener('click', () => {
        editingServiceId = null;
        modalTitle.textContent = 'æ·»åŠ æœåŠ¡';
        serviceForm.reset();
        resetIconUpload();
        document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('active'));
        document.querySelector('.icon-option[data-icon="ğŸŒ"]').classList.add('active');
        serviceModal.classList.add('active');
      });

      function openEditModal(id) {
        const service = services.find(s => s.id === id);
        if (!service) return;
        
        editingServiceId = id;
        modalTitle.textContent = 'ç¼–è¾‘æœåŠ¡';
        document.getElementById('serviceName').value = service.name;
        document.getElementById('serviceDesc').value = service.description || '';
        document.getElementById('servicePort').value = service.port || '';
        
        // è®¾ç½®å›¾æ ‡
        const isImage = service.icon && service.icon.startsWith('/');
        document.getElementById('serviceIcon').value = isImage ? service.icon : '';
        
        // é‡ç½®ä¸Šä¼ åŒºåŸŸ
        resetIconUpload();
        
        if (isImage) {
          // æ˜¾ç¤ºå·²æœ‰å›¾æ ‡é¢„è§ˆ
          showIconPreview(service.icon, 'å½“å‰å›¾æ ‡');
        } else {
          // é€‰ä¸­å¯¹åº”çš„ emoji
          document.querySelectorAll('.icon-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.icon === service.icon);
          });
        }
        
        serviceModal.classList.add('active');
      }

      function openDeleteModal(id) {
        const service = services.find(s => s.id === id);
        if (!service) return;
        
        deletingServiceId = id;
        deleteServiceName.textContent = service.name;
        deleteModal.classList.add('active');
      }

      function closeModals() {
        serviceModal.classList.remove('active');
        deleteModal.classList.remove('active');
        editingServiceId = null;
        deletingServiceId = null;
        // é‡ç½®ä¸Šä¼ åŒºåŸŸ
        resetIconUpload();
      }

      function resetIconUpload() {
        const zone = document.getElementById('iconUploadZone');
        const preview = document.getElementById('uploadPreview');
        zone.classList.remove('has-preview');
        preview.innerHTML = '';
        document.getElementById('iconFileInput').value = '';
      }

      modalClose.addEventListener('click', closeModals);
      cancelBtn.addEventListener('click', closeModals);
      cancelDeleteBtn.addEventListener('click', closeModals);

      // ========== å›¾æ ‡ä¸Šä¼ /æ‹–æ‹½ ==========
      const iconUploadZone = document.getElementById('iconUploadZone');
      const iconFileInput = document.getElementById('iconFileInput');

      iconUploadZone.addEventListener('click', () => {
        iconFileInput.click();
      });

      iconUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        iconUploadZone.classList.add('dragover');
      });

      iconUploadZone.addEventListener('dragleave', () => {
        iconUploadZone.classList.remove('dragover');
      });

      iconUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        iconUploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleIconFile(files[0]);
        }
      });

      iconFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleIconFile(e.target.files[0]);
        }
      });

      async function handleIconFile(file) {
        // éªŒè¯æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
          alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
          return;
        }

        // éªŒè¯æ–‡ä»¶å¤§å°
        if (file.size > 2 * 1024 * 1024) {
          alert('æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§ 2MB');
          return;
        }

        // ä¸Šä¼ æ–‡ä»¶
        const formData = new FormData();
        formData.append('icon', file);

        try {
          const response = await fetch('/api/upload-icon', {
            method: 'POST',
            body: formData
          });
          const result = await response.json();

          if (result.success) {
            // æ˜¾ç¤ºé¢„è§ˆ
            showIconPreview(result.icon, file.name);
            // è®¾ç½®åˆ°éšè—å­—æ®µ
            document.getElementById('serviceIcon').value = result.icon;
            // å–æ¶ˆ emoji é€‰æ‹©
            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('active'));
          } else {
            alert('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (e) {
          alert('ä¸Šä¼ å¤±è´¥');
        }
      }

      function showIconPreview(iconUrl, fileName) {
        const zone = document.getElementById('iconUploadZone');
        const preview = document.getElementById('uploadPreview');
        
        zone.classList.add('has-preview');
        preview.innerHTML = `
          <img src="${iconUrl}" alt="icon" />
          <div class="preview-info">
            <div class="preview-name">${fileName}</div>
            <div class="preview-change">ç‚¹å‡»æ›´æ¢</div>
          </div>
        `;
      }

      // å›¾æ ‡é€‰æ‹© (Emoji)
      document.querySelectorAll('.icon-option').forEach(opt => {
        opt.addEventListener('click', () => {
          document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('active'));
          opt.classList.add('active');
          document.getElementById('serviceIcon').value = '';
          resetIconUpload();
        });
      });

      // ä¿å­˜æœåŠ¡
      serviceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const activeIcon = document.querySelector('.icon-option.active');
        const customIcon = document.getElementById('serviceIcon').value.trim();
        const icon = customIcon || (activeIcon ? activeIcon.dataset.icon : 'ğŸŒ');
        
        const data = {
          name: document.getElementById('serviceName').value.trim(),
          description: document.getElementById('serviceDesc').value.trim(),
          port: parseInt(document.getElementById('servicePort').value) || 0,
          icon: icon,
          enabled: parseInt(document.getElementById('servicePort').value) > 0
        };

        try {
          let response;
          if (editingServiceId) {
            response = await fetch(`/api/services/${editingServiceId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
          } else {
            response = await fetch('/api/services', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
          }

          if (response.ok) {
            closeModals();
            await loadServices();
          }
        } catch (e) {
          console.log('ä¿å­˜å¤±è´¥');
        }
      });

      // åˆ é™¤æœåŠ¡
      confirmDeleteBtn.addEventListener('click', async () => {
        if (!deletingServiceId) return;
        
        try {
          const response = await fetch(`/api/services/${deletingServiceId}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            closeModals();
            await loadServices();
          }
        } catch (e) {
          console.log('åˆ é™¤å¤±è´¥');
        }
      });

      // ç‚¹å‡»é®ç½©å…³é—­
      serviceModal.addEventListener('click', (e) => {
        if (e.target === serviceModal) closeModals();
      });
      deleteModal.addEventListener('click', (e) => {
        if (e.target === deleteModal) closeModals();
      });

      // ========== é¡µé¢å¯¼èˆª ==========
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          switchPage(page);
          sidebar.classList.remove('open');
        });
      });

      function switchPage(pageName) {
        document.querySelectorAll('.nav-item').forEach(nav => {
          nav.classList.toggle('active', nav.dataset.page === pageName);
        });
        document.querySelectorAll('.page-view').forEach(view => {
          view.classList.toggle('active', view.id === `page-${pageName}`);
        });
        
        // WebSocket å§‹ç»ˆä¿æŒè¿æ¥ï¼ˆç”¨äºé¡¶éƒ¨æ çŠ¶æ€æ˜¾ç¤ºï¼‰
        connectMonitorWs();
        
        if (pageName === 'process') {
          loadProcesses();
        } else if (pageName === 'files') {
          loadWebdavRoot();
          loadFiles(currentFilePath);
          updateWebdavUrl();
        } else if (pageName === 'ssh') {
          connectTerminal();
        } else if (pageName === 'docker') {
          loadDockerContainers();
        }
      }

      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
      });

      // ========== WebSocket ç›‘æ§ ==========
      function connectMonitorWs() {
        if (monitorWs && monitorWs.readyState === WebSocket.OPEN) return;
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/monitor`;
        
        monitorWs = new WebSocket(wsUrl);
        
        monitorWs.onopen = () => {
          updateConnectionStatus(true);
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
        };
        
        monitorWs.onmessage = (event) => {
          const stats = JSON.parse(event.data);
          updateMonitorUI(stats);
        };
        
        monitorWs.onclose = () => {
          updateConnectionStatus(false);
          if (document.getElementById('page-monitor').classList.contains('active')) {
            reconnectTimer = setTimeout(connectMonitorWs, 3000);
          }
        };
        
        monitorWs.onerror = () => {
          updateConnectionStatus(false);
        };
      }

      function disconnectMonitorWs() {
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
        if (monitorWs) {
          monitorWs.close();
          monitorWs = null;
        }
      }

      function updateConnectionStatus(connected) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        dot.classList.toggle('connected', connected);
        text.textContent = connected ? 'å·²è¿æ¥ Â· å®æ—¶æ›´æ–°ä¸­' : 'è¿æ¥æ–­å¼€ Â· æ­£åœ¨é‡è¿...';
      }

      function updateTopBarStats(stats) {
        // CPU
        document.getElementById('topCpu').textContent = Math.round(stats.cpu.usage) + '%';
        
        // å†…å­˜
        document.getElementById('topMem').textContent = Math.round(stats.memory.usedPercent) + '%';
        
        // GPU
        if (stats.gpu.available) {
          document.getElementById('topGpu').textContent = Math.round(stats.gpu.usage) + '%';
        } else {
          document.getElementById('topGpu').textContent = 'N/A';
        }
        
        // ç½‘ç»œ
        if (stats.network) {
          document.getElementById('topNetUp').textContent = formatSpeedShort(stats.network.speedSent);
          document.getElementById('topNetDown').textContent = formatSpeedShort(stats.network.speedRecv);
        }
      }

      function formatSpeedShort(bytesPerSec) {
        if (bytesPerSec === 0) return '0';
        const k = 1024;
        if (bytesPerSec < k) return bytesPerSec + 'B';
        if (bytesPerSec < k * k) return Math.round(bytesPerSec / k) + 'K';
        if (bytesPerSec < k * k * k) return (bytesPerSec / k / k).toFixed(1) + 'M';
        return (bytesPerSec / k / k / k).toFixed(1) + 'G';
      }

      function updateMonitorUI(stats) {
        // æ›´æ–°é¡¶éƒ¨æ çŠ¶æ€å°å›¾æ ‡
        updateTopBarStats(stats);
        
        updateRing('cpuRing', stats.cpu.usage);
        document.getElementById('cpuValue').textContent = Math.round(stats.cpu.usage);
        document.getElementById('cpuModel').textContent = stats.cpu.modelName || '-';
        document.getElementById('cpuCores').textContent = `${stats.cpu.cores} æ ¸å¿ƒ`;
        
        // CPU æ¸©åº¦
        const cpuTempEl = document.getElementById('cpuTemp');
        if (stats.cpu.temperature > 0) {
          cpuTempEl.style.display = 'flex';
          cpuTempEl.querySelector('.temp-value').textContent = Math.round(stats.cpu.temperature);
          cpuTempEl.className = 'temp-badge' + getTempClass(stats.cpu.temperature);
        } else {
          cpuTempEl.style.display = 'none';
        }
        
        updateRing('memoryRing', stats.memory.usedPercent);
        document.getElementById('memoryValue').textContent = Math.round(stats.memory.usedPercent);
        document.getElementById('memoryUsed').textContent = 
          `${formatBytes(stats.memory.used)} / ${formatBytes(stats.memory.total)}`;
        document.getElementById('memoryAvailable').textContent = 
          `å¯ç”¨: ${formatBytes(stats.memory.available)}`;
        
        if (stats.gpu.available) {
          document.getElementById('gpuContent').style.display = 'block';
          document.getElementById('gpuUnavailable').style.display = 'none';
          updateRing('gpuRing', stats.gpu.usage);
          document.getElementById('gpuValue').textContent = Math.round(stats.gpu.usage);
          document.getElementById('gpuModel').textContent = stats.gpu.name || '-';
          document.getElementById('gpuMemory').textContent = 
            `æ˜¾å­˜: ${stats.gpu.memoryUsed} / ${stats.gpu.memoryTotal} MB`;
          
          // GPU æ¸©åº¦
          const gpuTempEl = document.getElementById('gpuTemp');
          if (stats.gpu.temperature > 0) {
            gpuTempEl.style.display = 'flex';
            gpuTempEl.querySelector('.temp-value').textContent = Math.round(stats.gpu.temperature);
            gpuTempEl.className = 'temp-badge' + getTempClass(stats.gpu.temperature);
          }
        } else {
          document.getElementById('gpuContent').style.display = 'none';
          document.getElementById('gpuUnavailable').style.display = 'block';
        }
        
        // ç½‘ç»œæµé‡
        if (stats.network) {
          document.getElementById('netSpeedUp').textContent = formatSpeed(stats.network.speedSent);
          document.getElementById('netSpeedDown').textContent = formatSpeed(stats.network.speedRecv);
          document.getElementById('netTotalUp').textContent = formatBytes(stats.network.bytesSent);
          document.getElementById('netTotalDown').textContent = formatBytes(stats.network.bytesRecv);
        }
        
        updateDisks(stats.disks);
      }

      function getTempClass(temp) {
        if (temp >= 80) return ' temp-danger';
        if (temp >= 60) return ' temp-warning';
        return '';
      }

      function updateRing(id, percent) {
        const ring = document.getElementById(id);
        const circumference = 2 * Math.PI * 60;
        const offset = circumference - (percent / 100) * circumference;
        ring.style.strokeDashoffset = offset;
      }

      function updateDisks(disks) {
        const container = document.getElementById('diskList');
        container.innerHTML = disks.map(disk => {
          const percent = disk.usedPercent;
          let barClass = '';
          if (percent >= 90) barClass = 'danger';
          else if (percent >= 75) barClass = 'warning';
          
          return `
            <div class="disk-item">
              <div class="disk-header">
                <span class="disk-name">${disk.mountPoint}</span>
                <span class="disk-usage">${formatBytes(disk.used)} / ${formatBytes(disk.total)}</span>
              </div>
              <div class="disk-bar">
                <div class="disk-bar-fill ${barClass}" style="width: ${percent}%"></div>
              </div>
            </div>
          `;
        }).join('');
      }

      function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      function formatSpeed(bytesPerSec) {
        if (bytesPerSec === 0) return '0 B/s';
        const k = 1024;
        const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
        const i = Math.floor(Math.log(bytesPerSec) / Math.log(k));
        return parseFloat((bytesPerSec / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      // ========== è®¾ç½®ç®¡ç† ==========
      async function loadSettingsFromServer() {
        try {
          const response = await fetch('/api/settings');
          if (response.ok) {
            currentSettings = await response.json();
          }
        } catch (e) {
          console.log('æ— æ³•åŠ è½½æœåŠ¡å™¨è®¾ç½®');
        }
        applySettings();
      }

      function saveSettingsToServer() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
          try {
            await fetch('/api/settings', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(currentSettings)
            });
          } catch (e) {
            console.log('ä¿å­˜è®¾ç½®å¤±è´¥');
          }
        }, 500);
      }

      async function loadPresetBackgrounds() {
        try {
          const response = await fetch('/api/backgrounds');
          if (response.ok) {
            presetBackgrounds = await response.json();
          }
        } catch (e) {
          console.log('æ— æ³•åŠ è½½é¢„è®¾èƒŒæ™¯');
        }
        renderBackgroundOptions();
      }

      function applySettings() {
        if (currentSettings.serverIp) {
          serverIpInput.value = currentSettings.serverIp;
        }
        if (currentSettings.backgroundUrl) {
          bgLayer.style.backgroundImage = `url('${currentSettings.backgroundUrl}')`;
        }
        // åº”ç”¨ä¸»é¢˜
        applyTheme(currentSettings.theme || 'dark');
      }

      function applyTheme(theme) {
        if (theme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
          document.getElementById('themeToggle').checked = true;
        } else {
          document.documentElement.removeAttribute('data-theme');
          document.getElementById('themeToggle').checked = false;
        }
      }

      // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
      document.getElementById('themeToggle').addEventListener('change', (e) => {
        const theme = e.target.checked ? 'light' : 'dark';
        currentSettings.theme = theme;
        applyTheme(theme);
        saveSettingsToServer();
      });

      serverIpInput.addEventListener('input', (e) => {
        const ip = e.target.value.trim();
        if (ip) {
          currentSettings.serverIp = ip;
          saveSettingsToServer();
          updateServiceLinks();
        }
      });

      function renderBackgroundOptions() {
        bgGrid.innerHTML = '';
        presetBackgrounds.forEach(bg => {
          const option = document.createElement('div');
          option.className = 'bg-option' + (currentSettings.backgroundUrl === bg.url ? ' active' : '');
          option.innerHTML = `<img src="${bg.thumb || bg.url}" alt="${bg.name}" />`;
          option.addEventListener('click', () => setBackground(bg.url));
          bgGrid.appendChild(option);
        });
      }

      function setBackground(url) {
        bgLayer.style.backgroundImage = `url('${url}')`;
        currentSettings.backgroundUrl = url;
        saveSettingsToServer();
        document.querySelectorAll('.bg-option').forEach((opt, i) => {
          opt.classList.toggle('active', presetBackgrounds[i]?.url === url);
        });
      }

      settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsPanel.classList.toggle('active');
      });

      document.addEventListener('click', (e) => {
        if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
          settingsPanel.classList.remove('active');
        }
      });

      // ========== äº‹ä»¶ç»‘å®š ==========
      document.getElementById('pingAllBtn').addEventListener('click', pingAllServices);
      document.getElementById('importTemplateBtn').addEventListener('click', importTemplate);
      document.getElementById('emptyImportBtn').addEventListener('click', importTemplate);
      document.getElementById('fetchFaviconBtn').addEventListener('click', fetchFavicon);
      document.getElementById('refreshProcessBtn').addEventListener('click', loadProcesses);

      // ========== æ–‡ä»¶ç®¡ç† ==========
      async function loadFiles(path) {
        currentFilePath = path;
        const tbody = document.getElementById('fileTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½ä¸­...</td></tr>';
        
        try {
          const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
          if (response.ok) {
            const data = await response.json();
            renderFiles(data.files || []);
            renderBreadcrumb(path);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½å¤±è´¥</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½å¤±è´¥</td></tr>';
        }
      }

      function renderFiles(files) {
        const tbody = document.getElementById('fileTableBody');
        if (!files || files.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="loading-row">æ–‡ä»¶å¤¹ä¸ºç©º</td></tr>';
          return;
        }
        
        tbody.innerHTML = files.map(file => {
          const icon = file.isDir ? 'ğŸ“' : getFileIcon(file.name);
          const size = file.isDir ? '-' : formatBytes(file.size);
          const time = new Date(file.modTime).toLocaleString('zh-CN');
          
          return `
            <tr class="file-row" data-path="${file.path}" data-isdir="${file.isDir}">
              <td class="col-icon">${icon}</td>
              <td class="col-name">${file.name}</td>
              <td class="col-size">${size}</td>
              <td class="col-time">${time}</td>
              <td class="col-actions">
                ${file.isDir ? '' : `<button class="btn-icon" onclick="downloadFile('${file.path}')" title="ä¸‹è½½">ğŸ“¥</button>`}
                <button class="btn-icon btn-danger-icon" onclick="openDeleteFileModal('${file.path}', '${file.name}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        }).join('');
        
        // ç»‘å®šåŒå‡»äº‹ä»¶è¿›å…¥æ–‡ä»¶å¤¹
        document.querySelectorAll('.file-row').forEach(row => {
          row.addEventListener('dblclick', () => {
            if (row.dataset.isdir === 'true') {
              loadFiles(row.dataset.path);
            }
          });
        });
      }

      function renderBreadcrumb(path) {
        const breadcrumb = document.getElementById('breadcrumb');
        const parts = path.split('/').filter(p => p);
        
        let html = `<span class="breadcrumb-item" data-path="/" onclick="loadFiles('/')">ğŸ  æ ¹ç›®å½•</span>`;
        let currentPath = '';
        
        parts.forEach((part, index) => {
          currentPath += '/' + part;
          const isLast = index === parts.length - 1;
          html += `<span class="breadcrumb-sep">/</span>`;
          html += `<span class="breadcrumb-item${isLast ? ' active' : ''}" data-path="${currentPath}" onclick="loadFiles('${currentPath}')">${part}</span>`;
        });
        
        breadcrumb.innerHTML = html;
      }

      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
          'pdf': 'ğŸ“„', 'doc': 'ğŸ“', 'docx': 'ğŸ“', 'txt': 'ğŸ“',
          'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'csv': 'ğŸ“Š',
          'ppt': 'ğŸ“½ï¸', 'pptx': 'ğŸ“½ï¸',
          'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'webp': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸',
          'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ', 'aac': 'ğŸµ',
          'mp4': 'ğŸ¬', 'mkv': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'wmv': 'ğŸ¬',
          'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦', 'tar': 'ğŸ“¦', 'gz': 'ğŸ“¦',
          'exe': 'âš™ï¸', 'msi': 'âš™ï¸', 'bat': 'âš™ï¸', 'sh': 'âš™ï¸',
          'js': 'ğŸ“œ', 'ts': 'ğŸ“œ', 'py': 'ğŸ“œ', 'go': 'ğŸ“œ', 'java': 'ğŸ“œ',
          'html': 'ğŸŒ', 'css': 'ğŸ¨', 'json': 'ğŸ“‹', 'xml': 'ğŸ“‹',
        };
        return icons[ext] || 'ğŸ“„';
      }

      function downloadFile(path) {
        window.open(`/api/files/download?path=${encodeURIComponent(path)}`, '_blank');
      }

      function openDeleteFileModal(path, name) {
        deletingFilePath = path;
        document.getElementById('deleteFileName').textContent = name;
        document.getElementById('deleteFileModal').classList.add('active');
      }

      function closeFileModals() {
        document.getElementById('newFolderModal').classList.remove('active');
        document.getElementById('deleteFileModal').classList.remove('active');
        deletingFilePath = null;
      }

      // æ–°å»ºæ–‡ä»¶å¤¹
      document.getElementById('newFolderBtn').addEventListener('click', () => {
        document.getElementById('folderName').value = '';
        document.getElementById('newFolderModal').classList.add('active');
      });

      document.getElementById('closeFolderModal').addEventListener('click', closeFileModals);
      document.getElementById('cancelFolderBtn').addEventListener('click', closeFileModals);
      document.getElementById('cancelDeleteFileBtn').addEventListener('click', closeFileModals);

      document.getElementById('confirmFolderBtn').addEventListener('click', async () => {
        const name = document.getElementById('folderName').value.trim();
        if (!name) {
          alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
          return;
        }
        
        const newPath = currentFilePath === '/' ? '/' + name : currentFilePath + '/' + name;
        
        try {
          const response = await fetch('/api/files/mkdir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: newPath })
          });
          
          if (response.ok) {
            closeFileModals();
            loadFiles(currentFilePath);
          } else {
            alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
          }
        } catch (e) {
          alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
        }
      });

      // åˆ é™¤æ–‡ä»¶
      document.getElementById('confirmDeleteFileBtn').addEventListener('click', async () => {
        if (!deletingFilePath) return;
        
        try {
          const response = await fetch(`/api/files?path=${encodeURIComponent(deletingFilePath)}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            closeFileModals();
            loadFiles(currentFilePath);
          } else {
            alert('åˆ é™¤å¤±è´¥');
          }
        } catch (e) {
          alert('åˆ é™¤å¤±è´¥');
        }
      });

      // ä¸Šä¼ æ–‡ä»¶
      document.getElementById('uploadFileBtn').addEventListener('click', () => {
        document.getElementById('fileUploadInput').click();
      });

      document.getElementById('fileUploadInput').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        
        for (const file of files) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('path', currentFilePath);
          
          try {
            await fetch('/api/files/upload', {
              method: 'POST',
              body: formData
            });
          } catch (e) {
            console.log('ä¸Šä¼ å¤±è´¥:', file.name);
          }
        }
        
        e.target.value = '';
        loadFiles(currentFilePath);
      });

      // WebDAV URL
      function updateWebdavUrl() {
        const protocol = window.location.protocol;
        const host = window.location.host;
        document.getElementById('webdavUrl').textContent = `${protocol}//${host}/webdav/`;
      }

      // åŠ è½½ WebDAV æ ¹ç›®å½•
      async function loadWebdavRoot() {
        try {
          const response = await fetch('/api/webdav-root');
          if (response.ok) {
            const data = await response.json();
            document.getElementById('webdavRootInput').value = data.root || '';
          }
        } catch (e) {
          console.log('åŠ è½½ WebDAV æ ¹ç›®å½•å¤±è´¥');
        }
      }

      // è®¾ç½® WebDAV æ ¹ç›®å½•
      document.getElementById('setWebdavRootBtn').addEventListener('click', async () => {
        const root = document.getElementById('webdavRootInput').value.trim();
        if (!root) {
          alert('è¯·è¾“å…¥ç›®å½•è·¯å¾„');
          return;
        }

        try {
          const response = await fetch('/api/webdav-root', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ root })
          });

          const result = await response.json();
          if (response.ok) {
            alert('è®¾ç½®æˆåŠŸï¼');
            currentFilePath = '/';
            loadFiles('/');
          } else {
            alert('è®¾ç½®å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (e) {
          alert('è®¾ç½®å¤±è´¥');
        }
      });

      document.getElementById('copyWebdavBtn').addEventListener('click', () => {
        const url = document.getElementById('webdavUrl').textContent;
        navigator.clipboard.writeText(url).then(() => {
          alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        });
      });

      // å¼¹çª—å…³é—­
      document.getElementById('newFolderModal').addEventListener('click', (e) => {
        if (e.target.id === 'newFolderModal') closeFileModals();
      });
      document.getElementById('deleteFileModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteFileModal') closeFileModals();
      });

      // ========== SSH ç»ˆç«¯ ==========
      function connectTerminal() {
        if (terminalWs && terminalWs.readyState === WebSocket.OPEN) return;
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/terminal`;
        
        updateTerminalStatus('connecting');
        terminalWs = new WebSocket(wsUrl);
        
        terminalWs.onopen = () => {
          updateTerminalStatus('connected');
          // èšç„¦è¾“å…¥æ¡†
          document.getElementById('terminalInput').focus();
        };
        
        terminalWs.onmessage = (event) => {
          appendTerminalOutput(event.data);
        };
        
        terminalWs.onclose = () => {
          updateTerminalStatus('disconnected');
        };
        
        terminalWs.onerror = () => {
          updateTerminalStatus('error');
        };
      }

      function updateTerminalStatus(status) {
        const statusEl = document.getElementById('terminalStatus');
        const dot = statusEl.querySelector('.status-dot');
        const text = statusEl.querySelector('span:last-child');
        
        dot.className = 'status-dot';
        switch (status) {
          case 'connected':
            dot.classList.add('connected');
            text.textContent = 'å·²è¿æ¥';
            break;
          case 'connecting':
            text.textContent = 'è¿æ¥ä¸­...';
            break;
          case 'disconnected':
            text.textContent = 'å·²æ–­å¼€';
            break;
          case 'error':
            dot.classList.add('error');
            text.textContent = 'è¿æ¥é”™è¯¯';
            break;
        }
      }

      function appendTerminalOutput(text) {
        const output = document.getElementById('terminalOutput');
        const line = document.createElement('div');
        line.className = 'terminal-line';
        // è§£æ ANSI é¢œè‰²ä»£ç 
        let html = text
          .replace(/\x1b\[31m/g, '<span class="text-red">')
          .replace(/\x1b\[32m/g, '<span class="text-green">')
          .replace(/\x1b\[33m/g, '<span class="text-yellow">')
          .replace(/\x1b\[34m/g, '<span class="text-blue">')
          .replace(/\x1b\[35m/g, '<span class="text-magenta">')
          .replace(/\x1b\[36m/g, '<span class="text-cyan">')
          .replace(/\x1b\[0m/g, '</span>');
        line.innerHTML = html;
        output.appendChild(line);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        const wrapper = document.getElementById('terminal');
        wrapper.scrollTop = wrapper.scrollHeight;
      }

      function sendTerminalCommand() {
        const input = document.getElementById('terminalInput');
        const cmd = input.value;
        if (!terminalWs || terminalWs.readyState !== WebSocket.OPEN) {
          appendTerminalOutput('<span class="text-red">æœªè¿æ¥åˆ°ç»ˆç«¯</span>');
          return;
        }
        
        // æ˜¾ç¤ºè¾“å…¥çš„å‘½ä»¤ï¼ˆå¸¦æç¤ºç¬¦ï¼‰
        const prompt = document.getElementById('terminalPrompt').textContent;
        appendTerminalOutput(`<span class="text-green">${prompt}</span> ${cmd}`);
        
        // ä¿å­˜åˆ°å†å²ï¼ˆéç©ºå‘½ä»¤ï¼‰
        if (cmd.trim()) {
          terminalHistory.push(cmd);
          historyIndex = terminalHistory.length;
        }
        
        // å‘é€å‘½ä»¤
        terminalWs.send(cmd);
        input.value = '';
      }

      // ç»ˆç«¯è¾“å…¥äº‹ä»¶
      document.getElementById('terminalInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendTerminalCommand();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (historyIndex > 0) {
            historyIndex--;
            e.target.value = terminalHistory[historyIndex];
            // å…‰æ ‡ç§»åˆ°æœ«å°¾
            setTimeout(() => e.target.setSelectionRange(e.target.value.length, e.target.value.length), 0);
          }
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (historyIndex < terminalHistory.length - 1) {
            historyIndex++;
            e.target.value = terminalHistory[historyIndex];
          } else {
            historyIndex = terminalHistory.length;
            e.target.value = '';
          }
        } else if (e.key === 'c' && e.ctrlKey) {
          // Ctrl+C ä¸­æ–­
          if (terminalWs && terminalWs.readyState === WebSocket.OPEN) {
            terminalWs.send('\x03');
          }
        } else if (e.key === 'l' && e.ctrlKey) {
          // Ctrl+L æ¸…å±
          e.preventDefault();
          document.getElementById('terminalOutput').innerHTML = '';
        }
      });

      // ç‚¹å‡»ç»ˆç«¯åŒºåŸŸèšç„¦è¾“å…¥æ¡†
      document.getElementById('terminal').addEventListener('click', () => {
        document.getElementById('terminalInput').focus();
      });

      document.getElementById('connectTerminalBtn').addEventListener('click', () => {
        if (terminalWs) {
          terminalWs.close();
          terminalWs = null;
        }
        document.getElementById('terminalOutput').innerHTML = '';
        connectTerminal();
      });

      document.getElementById('clearTerminalBtn').addEventListener('click', () => {
        document.getElementById('terminalOutput').innerHTML = '';
      });

      // ========== Docker ç®¡ç† ==========
      async function loadDockerContainers() {
        const tbody = document.getElementById('dockerTableBody');
        const status = document.getElementById('dockerStatus');
        tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½ä¸­...</td></tr>';
        
        try {
          const response = await fetch('/api/docker/containers');
          if (response.ok) {
            const containers = await response.json();
            renderDockerContainers(containers);
            
            if (containers && containers.length > 0) {
              status.innerHTML = '<span class="status-dot connected"></span><span>Docker å·²è¿æ¥</span>';
            } else {
              status.innerHTML = '<span class="status-dot"></span><span>æœªæ£€æµ‹åˆ°å®¹å™¨</span>';
            }
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="loading-row">åŠ è½½å¤±è´¥</td></tr>';
            status.innerHTML = '<span class="status-dot error"></span><span>Docker æœªè¿è¡Œæˆ–æœªå®‰è£…</span>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="5" class="loading-row">æ— æ³•è¿æ¥ Docker</td></tr>';
          status.innerHTML = '<span class="status-dot error"></span><span>Docker æœªè¿è¡Œæˆ–æœªå®‰è£…</span>';
        }
      }

      function renderDockerContainers(containers) {
        const tbody = document.getElementById('dockerTableBody');
        if (!containers || containers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="loading-row">æš‚æ— å®¹å™¨</td></tr>';
          return;
        }
        
        tbody.innerHTML = containers.map(c => {
          const isRunning = c.state === 'running';
          const statusClass = isRunning ? 'running' : 'stopped';
          const statusDot = isRunning ? 'ğŸŸ¢' : 'ğŸ”´';
          
          return `
            <tr class="docker-row">
              <td class="col-status">${statusDot}</td>
              <td class="container-name">${c.name}</td>
              <td class="container-image">${c.image}</td>
              <td class="container-status ${statusClass}">${c.status}</td>
              <td class="container-ports">${c.ports || '-'}</td>
            </tr>
          `;
        }).join('');
      }

      document.getElementById('refreshDockerBtn').addEventListener('click', loadDockerContainers);

      // ========== åˆå§‹åŒ– ==========
      document.addEventListener('DOMContentLoaded', async () => {
        await loadSettingsFromServer();
        await loadServices();
        await loadPresetBackgrounds();
        
        // è¿æ¥ WebSocket ä»¥æ›´æ–°é¡¶éƒ¨æ çŠ¶æ€
        connectMonitorWs();
        
        // é¦–é¡µåŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹è¿é€šæ€§
        setTimeout(pingAllServices, 1000);
        
        // æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°è¿é€šçŠ¶æ€
        pingInterval = setInterval(() => {
          if (document.getElementById('page-home').classList.contains('active')) {
            pingAllServices();
          }
        }, 30000);
      });
    </script>
  </body>
</html>
